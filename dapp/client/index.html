<!doctype html>
<html lang="us">
	<head>
		<meta charset="utf-8">
		<title>Recoverable Wallet</title>
		<link href="index.css" rel='stylesheet' type='text/css'>
		<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
		<link href="https://unpkg.com/ace-css/css/ace.min.css" rel="stylesheet">
		<script src="/parity-utils/parity.js"></script>
	</head>
	<body>
		<div id="container"></div>
		<script src="app.js"></script>
		<script>
			const app = Elm.App.embed(document.getElementById('container'));

			const factoryAbi = JSON.parse('[{"constant":false,"inputs":[{"name":"recoveryDelayInDays","type":"uint8"}],"name":"createWallet","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"walletOwner","type":"address"}],"name":"getWalletFor","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"anonymous":false,"inputs":[{"indexed":true,"name":"owner","type":"address"}],"name":"WalletCreated","type":"event"}]');
			const walletAbi = JSON.parse('[{"constant":false,"inputs":[],"name":"cancelRecovery","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"_recoveryDelayDays","outputs":[{"name":"","type":"uint8"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"_activeRecoveryStartTime","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"tokenAddress","type":"address"},{"name":"destination","type":"address"},{"name":"amount","type":"uint256"}],"name":"sendToken","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"claimOwnership","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"_recoveryAddresses","outputs":[{"name":"","type":"bool"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"oldRecoveryAddress","type":"address"}],"name":"removeRecoveryAddress","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"_activeRecoveryAddress","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"newRecoveryAddress","type":"address"}],"name":"addRecoveryAddress","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"_owner","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"newOwnerAddress","type":"address"}],"name":"startRecovery","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"destination","type":"address"},{"name":"amount","type":"uint256"}],"name":"sendEther","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"finishRecovery","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"_pendingOwner","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"tokenAddress","type":"address"},{"name":"spender","type":"address"},{"name":"amount","type":"uint256"}],"name":"approveToken","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"payable":false,"type":"function"},{"inputs":[{"name":"recoveryDelayInDays","type":"uint8"},{"name":"owner","type":"address"}],"payable":false,"type":"constructor"},{"payable":true,"type":"fallback"},{"anonymous":false,"inputs":[{"indexed":true,"name":"newRecoverer","type":"address"}],"name":"RecoveryAddressAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"oldRecoverer","type":"address"}],"name":"RecoveryAddressRemoved","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"newOwner","type":"address"}],"name":"RecoveryStarted","type":"event"},{"anonymous":false,"inputs":[],"name":"RecoveryCancelled","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"newOwner","type":"address"}],"name":"RecoveryFinished","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"oldOwner","type":"address"},{"indexed":true,"name":"newOwner","type":"address"}],"name":"OwnershipTransferStarted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"oldOwner","type":"address"},{"indexed":true,"name":"newOwner","type":"address"}],"name":"OwnershipTransferFinished","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"oldOwner","type":"address"},{"indexed":true,"name":"newOwner","type":"address"}],"name":"OwnerChanged","type":"event"}]');
			const factory = window.parity.api.newContract(factoryAbi).at('0x1B69BCd7A17ec0C3b6a66212306C903A53533613');

			app.ports.requestAddress.subscribe(() => window.parity.api.eth.coinbase().then(app.ports.addressChanged.send));
			app.ports.requestWallet.subscribe(address => factory.instance.getWalletFor.call({}, [address]).then(app.ports.walletChanged.send));
			app.ports.requestCreateWalletGasEstimate.subscribe(address => factory.instance.createWallet.estimateGas({}, [address]).then(app.ports.createWalletGasEstimate.send));
			app.ports.requestSendEthGasEstimate.subscribe((walletAddress, amount, recipientAddress) => window.parity.api.newContract(walletAbi).at(walletAddress).instance.sendEth.estimateGas({}, [recipientAddress, amount]).then(app.ports.sendEthGasEstimate.send));

			app.ports.createWallet.subscribe((address, gas, recoveryDelayInDays) => factory.instance.createWallet.postTransaction({ gas: gas }, [recoveryDelayInDays]));
			app.ports.sendEth.subscribe((walletAddress, amount, recipientAddress) => window.parity.api.newContract(walletAbi).at(walletAddress).instance.sendEth.postTransaction({gas:gas}, [recipientAddress, amount]));
			// TODO: getTokens port
			// TODO: sendToken port
			// TODO: add recoverer port
			// TODO: remove recoverer port
		</script>
		<div class="warning">
			<span>WARNING: This application is a work in progress!  Please don't use it yet, but check back later if it interests you.</span>
		</div>
	</body>
</html>
